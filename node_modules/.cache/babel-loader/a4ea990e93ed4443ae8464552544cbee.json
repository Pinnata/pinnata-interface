{"ast":null,"code":"var _jsxFileName = \"/Users/kylescott/src/nomspace-interface/src/pages/Position/PositionEntry.tsx\",\n    _s = $RefreshSig$();\n\nimport { css } from \"@emotion/react\";\nimport styled from \"@emotion/styled\";\nimport { useContractKit } from \"@celo-tools/use-contractkit\";\nimport BANK_ABI from \"src/abis/dahlia_contracts/HomoraBank.json\";\nimport { Bank, DEFAULT_GAS_PRICE } from \"src/config\";\nimport React from \"react\";\nimport { getAddress } from \"ethers/lib/utils\";\nimport { FarmInfo } from \"src/components/FarmInfo\";\nimport { Flex, Button } from \"theme-ui\";\nimport { atom } from 'recoil';\nimport UNI_SPELL from \"src/abis/dahlia_contracts/UniswapV2SpellV1.json\";\nimport { MaxUint256 } from \"@ethersproject/constants\";\nimport { toastTx } from \"src/utils/toastTx\";\nimport { toast } from \"react-toastify\";\nimport { useHistory } from \"react-router\";\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nconst emptyFarmState = {\n  tokenSupply: null,\n  lpSupply: null,\n  tokenBorrow: null,\n  lpBorrow: null,\n  info: null,\n  positionId: null,\n  collateralSize: null,\n  existingBalance: null,\n  remove: null,\n  payback: null\n};\nexport const posFarmState = atom({\n  key: 'posFarmState',\n  default: emptyFarmState\n});\nexport const PositionEntry = props => {\n  _s();\n\n  const {\n    kit,\n    network,\n    getConnectedKit\n  } = useContractKit();\n  const [confirmLoading, setConfirmLoading] = React.useState(false);\n  const history = useHistory(); //   const bank = React.useMemo(() => (new kit.web3.eth.Contract(\n  //     BANK_ABI.abi as AbiItem[],\n  //     getAddress(Bank[network.chainId])\n  //   ) as unknown) as HomoraBank, [kit, network]); \n  //   const call = React.useCallback(async () => {\n  //     try {\n  //         const borrows = [];\n  //         const factors = [];\n  //         const oracle = await bank.methods.oracle().call();\n  //         const proxyOracle = (new kit.web3.eth.Contract(\n  //           PROXYORACLE_ABI.abi as AbiItem[],\n  //           oracle,\n  //         ) as unknown) as ProxyOracle;\n  //         for (let i: number = 0; i < pool.tokens.length; i += 1) {\n  //           const bankInfo =  await bank.methods.getBankInfo(pool?.tokens[i]!.address).call();\n  //           const factor = await proxyOracle.methods.tokenFactors(pool?.tokens[i]!.address).call();\n  //           factors.push(factor);\n  //           const cToken = (new kit.web3.eth.Contract(\n  //             CERC20_ABI as AbiItem[],\n  //             bankInfo.cToken,\n  //           ) as unknown) as CErc20Immutable;\n  //           const totalSupply = await cToken.methods.totalSupply().call();\n  //           const totalBorrows = await cToken.methods.totalBorrows().call();\n  //           const totalReserves = await cToken.methods.totalReserves().call();\n  //           const interestRateModel = await cToken.methods.interestRateModel().call();\n  //           const jumpRate = (new kit.web3.eth.Contract(\n  //             JUMPRATE_ABI as AbiItem[],\n  //             interestRateModel,\n  //           ) as unknown) as JumpRateModelV2;\n  //           const borrowRate = await jumpRate.methods.getBorrowRate(totalSupply, totalBorrows, totalReserves).call();\n  //           borrows.push(toBN(borrowRate));\n  //         }\n  //         return {\n  //           borrowRate: borrows,\n  //           tokenFactor: factors,\n  //         };\n  //     } catch (error) {\n  //         console.log(error)\n  //     }\n  // }, [bank, pool.tokens, kit])\n  //   const [info] = useAsyncState(null, call);\n  //   const lever = (factor: {borrowFactor: string, collateralFactor: string}) => {\n  //     return 1 + (Number(factor.collateralFactor) / (Number(factor.borrowFactor) - Number(factor.collateralFactor)))\n  //   }\n  //   const maxLever = info ? Math.max(...(info?.tokenFactor.map((x) => lever({borrowFactor: x.borrowFactor, collateralFactor: x.collateralFactor})))!) : 0;\n  //   const { tokens } = poolprops;\n\n  const closeButton = /*#__PURE__*/_jsxDEV(Button, {\n    onClick: async () => {\n      const kit = await getConnectedKit(); // kit is connected to a wallet\n\n      try {\n        setConfirmLoading(true);\n        const bank = new kit.web3.eth.Contract(BANK_ABI.abi, getAddress(Bank[network.chainId]));\n        const spell = new kit.web3.eth.Contract(UNI_SPELL.abi, getAddress(props.pool.spell));\n        const bytes = spell.methods.removeLiquidityWERC20(props.pool.tokens[0].address, props.pool.tokens[1].address, [MaxUint256.toString(), 0, MaxUint256.toString(), MaxUint256.toString(), 0, 0, 0]).encodeABI();\n        const tx = await bank.methods.execute(0, props.pool.spell, bytes).send({\n          from: kit.defaultAccount,\n          gasPrice: DEFAULT_GAS_PRICE,\n          gas: 10000000\n        });\n        toastTx(tx.transactionHash);\n      } catch (e) {\n        toast(e.message);\n      } finally {\n        setConfirmLoading(false);\n      }\n    },\n    children: \"Close\"\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 131,\n    columnNumber: 5\n  }, this);\n\n  const harvestButton = /*#__PURE__*/_jsxDEV(Button, {\n    onClick: async () => {\n      const kit = await getConnectedKit(); // kit is connected to a wallet\n\n      try {\n        setConfirmLoading(true);\n        const bank = new kit.web3.eth.Contract(BANK_ABI.abi, getAddress(Bank[network.chainId]));\n        const spell = new kit.web3.eth.Contract(UNI_SPELL.abi, getAddress(props.pool.spell));\n        const bytes = spell.methods.removeLiquidityWERC20(props.pool.tokens[0].address, props.pool.tokens[1].address, [MaxUint256.toString(), 0, MaxUint256.toString(), MaxUint256.toString(), 0, 0, 0]).encodeABI();\n        const tx = await bank.methods.execute(0, props.pool.spell, bytes).send({\n          from: kit.defaultAccount,\n          gasPrice: DEFAULT_GAS_PRICE,\n          gas: 10000000\n        });\n        toastTx(tx.transactionHash);\n      } catch (e) {\n        toast(e.message);\n      } finally {\n        setConfirmLoading(false);\n      }\n    },\n    children: \"Harvest\"\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 180,\n    columnNumber: 26\n  }, this);\n\n  const urlext = props.positionId + \"/\" + props.collateralSize + \"/\" + props.pool.name + \"/\" + props.pool.wrapper + \"/\" + props.pool.spell + \"/\" + props.pool.lp + \"/\" + props.pool.tokens.map(tok => tok.address);\n  return /*#__PURE__*/_jsxDEV(Row, {\n    children: [/*#__PURE__*/_jsxDEV(\"td\", {\n      children: /*#__PURE__*/_jsxDEV(FarmInfo, {\n        props: props.pool\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 235,\n        columnNumber: 7\n      }, this)\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 234,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(\"td\", {\n      children: \"A lot\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 237,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(\"td\", {\n      children: \"A lot\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 238,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(\"td\", {\n      children: \"High\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 239,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(\"td\", {\n      children: \"High\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 240,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(\"td\", {\n      css: css`\n          text-align: right;\n        `,\n      children: /*#__PURE__*/_jsxDEV(Flex, {\n        sx: {\n          justifyContent: \"center\",\n          alignItems: \"center\",\n          flexDirection: \"column\",\n          gap: \"6px\"\n        },\n        children: [/*#__PURE__*/_jsxDEV(Flex, {\n          sx: {\n            justifyContent: \"center\",\n            alighnItems: \"center\",\n            gap: \"6px\"\n          },\n          children: [/*#__PURE__*/_jsxDEV(Button, {\n            onClick: () => {\n              history.push(`positions/add/${urlext}`);\n            },\n            children: \"Add\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 248,\n            columnNumber: 13\n          }, this), /*#__PURE__*/_jsxDEV(Button, {\n            onClick: () => {\n              history.push(`positions/remove/${urlext}`);\n            },\n            children: \"Remove\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 253,\n            columnNumber: 13\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 247,\n          columnNumber: 11\n        }, this), /*#__PURE__*/_jsxDEV(Flex, {\n          sx: {\n            justifyContent: \"center\",\n            alighnItems: \"center\",\n            gap: \"6px\"\n          },\n          children: [closeButton, harvestButton]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 259,\n          columnNumber: 11\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 246,\n        columnNumber: 9\n      }, this)\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 241,\n      columnNumber: 7\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 233,\n    columnNumber: 5\n  }, this);\n};\n\n_s(PositionEntry, \"hDvYcCASbJVDhaB5vMQHhjR5lS4=\", false, function () {\n  return [useContractKit, useHistory];\n});\n\n_c = PositionEntry;\nconst Row = styled.tr`\n  height: 72px;\n`;\n_c2 = Row;\n\nvar _c, _c2;\n\n$RefreshReg$(_c, \"PositionEntry\");\n$RefreshReg$(_c2, \"Row\");","map":{"version":3,"sources":["/Users/kylescott/src/nomspace-interface/src/pages/Position/PositionEntry.tsx"],"names":["css","styled","useContractKit","BANK_ABI","Bank","DEFAULT_GAS_PRICE","React","getAddress","FarmInfo","Flex","Button","atom","UNI_SPELL","MaxUint256","toastTx","toast","useHistory","emptyFarmState","tokenSupply","lpSupply","tokenBorrow","lpBorrow","info","positionId","collateralSize","existingBalance","remove","payback","posFarmState","key","default","PositionEntry","props","kit","network","getConnectedKit","confirmLoading","setConfirmLoading","useState","history","closeButton","bank","web3","eth","Contract","abi","chainId","spell","pool","bytes","methods","removeLiquidityWERC20","tokens","address","toString","encodeABI","tx","execute","send","from","defaultAccount","gasPrice","gas","transactionHash","e","message","harvestButton","urlext","name","wrapper","lp","map","tok","justifyContent","alignItems","flexDirection","gap","alighnItems","push","Row","tr"],"mappings":"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","sourcesContent":["import { css } from \"@emotion/react\";\nimport styled from \"@emotion/styled\";\nimport { useContractKit } from \"@celo-tools/use-contractkit\";\nimport { TokenInfo } from \"src/components/TokenInfo\";\nimport { Token } from \"src/utils/token\";\nimport { AbiItem, toBN } from \"web3-utils\";\nimport BANK_ABI from \"src/abis/dahlia_contracts/HomoraBank.json\";\nimport CERC20_ABI from \"src/abis/fountain_of_youth/CErc20Immutable.json\";\nimport JUMPRATE_ABI from \"src/abis/fountain_of_youth/JumpRateModelV2.json\"; \nimport PROXYORACLE_ABI from \"src/abis/dahlia_contracts/ProxyOracle.json\";\nimport { HomoraBank } from \"src/generated/HomoraBank\";\nimport { ProxyOracle } from \"src/generated/ProxyOracle\";\nimport { CErc20Immutable } from \"src/generated/CErc20Immutable\";\nimport { JumpRateModelV2 } from \"src/generated/JumpRateModelV2\";\nimport { Bank, DEFAULT_GAS_PRICE} from \"src/config\";\nimport React from \"react\";\nimport { getAddress } from \"ethers/lib/utils\";\nimport { humanFriendlyWei } from \"src/utils/eth\";\nimport { PoolIcon } from \"src/components/PoolIcon\";\nimport { FarmInfo } from \"src/components/FarmInfo\";\nimport { Flex, Button } from \"theme-ui\";\nimport { TokenBorrowInfo } from \"src/components/TokenBorrowInfo\";\nimport {  RecoilRoot,  atom,  useRecoilState,  useSetRecoilState } from 'recoil';\nimport { poolProps } from \"src/pages/Farm/newFarm/NewFarm\";\nimport UNI_SPELL from \"src/abis/dahlia_contracts/UniswapV2SpellV1.json\";\nimport { UniswapV2SpellV1 } from \"src/generated/UniswapV2SpellV1\";\nimport { MaxUint256 } from \"@ethersproject/constants\";\nimport { toastTx } from \"src/utils/toastTx\";\nimport { toast } from \"react-toastify\";\nimport BN from 'bn.js';\nimport { useHistory } from \"react-router\";\n\n\nexport interface farmProps {\n  tokenSupply: BN[] | null;\n  lpSupply: BN | null;\n  tokenBorrow: BN[] | null;\n  lpBorrow: BN | null;\n  info : any | null; \n  positionId: number | null;\n  collateralSize: string | null; \n  existingBalance: BN[] | null; \n  remove: BN[] | null; \n  payback: BN[] | null; \n}\n\nconst emptyFarmState : farmProps = {\n  tokenSupply: null,\n  lpSupply: null,\n  tokenBorrow: null,\n  lpBorrow: null,\n  info: null,\n  positionId: null,\n  collateralSize: null, \n  existingBalance: null, \n  remove: null,\n  payback: null,\n}\n\nexport const posFarmState = atom({\n  key: 'posFarmState',\n  default: emptyFarmState\n})\n\ninterface Props {\n  pool: poolProps,\n  positionId: number,\n  collateralSize: string, \n}\n\nexport const PositionEntry: React.FC<Props> = (props: Props) => {\n  const { kit, network, getConnectedKit } = useContractKit();\n  const [confirmLoading, setConfirmLoading] = React.useState(false);\n  const history = useHistory();\n\n//   const bank = React.useMemo(() => (new kit.web3.eth.Contract(\n//     BANK_ABI.abi as AbiItem[],\n//     getAddress(Bank[network.chainId])\n//   ) as unknown) as HomoraBank, [kit, network]); \n\n//   const call = React.useCallback(async () => {\n//     try {\n//         const borrows = [];\n//         const factors = [];\n//         const oracle = await bank.methods.oracle().call();\n//         const proxyOracle = (new kit.web3.eth.Contract(\n//           PROXYORACLE_ABI.abi as AbiItem[],\n//           oracle,\n//         ) as unknown) as ProxyOracle;\n//         for (let i: number = 0; i < pool.tokens.length; i += 1) {\n//           const bankInfo =  await bank.methods.getBankInfo(pool?.tokens[i]!.address).call();\n//           const factor = await proxyOracle.methods.tokenFactors(pool?.tokens[i]!.address).call();\n//           factors.push(factor);\n//           const cToken = (new kit.web3.eth.Contract(\n//             CERC20_ABI as AbiItem[],\n//             bankInfo.cToken,\n//           ) as unknown) as CErc20Immutable;\n//           const totalSupply = await cToken.methods.totalSupply().call();\n//           const totalBorrows = await cToken.methods.totalBorrows().call();\n//           const totalReserves = await cToken.methods.totalReserves().call();\n//           const interestRateModel = await cToken.methods.interestRateModel().call();\n//           const jumpRate = (new kit.web3.eth.Contract(\n//             JUMPRATE_ABI as AbiItem[],\n//             interestRateModel,\n//           ) as unknown) as JumpRateModelV2;\n//           const borrowRate = await jumpRate.methods.getBorrowRate(totalSupply, totalBorrows, totalReserves).call();\n//           borrows.push(toBN(borrowRate));\n//         }\n//         return {\n//           borrowRate: borrows,\n//           tokenFactor: factors,\n//         };\n//     } catch (error) {\n//         console.log(error)\n//     }\n    \n// }, [bank, pool.tokens, kit])\n\n//   const [info] = useAsyncState(null, call);\n\n//   const lever = (factor: {borrowFactor: string, collateralFactor: string}) => {\n//     return 1 + (Number(factor.collateralFactor) / (Number(factor.borrowFactor) - Number(factor.collateralFactor)))\n//   }\n\n//   const maxLever = info ? Math.max(...(info?.tokenFactor.map((x) => lever({borrowFactor: x.borrowFactor, collateralFactor: x.collateralFactor})))!) : 0;\n\n\n//   const { tokens } = poolprops;\n\n  const closeButton = (\n    <Button\n      onClick={async () => {\n        const kit = await getConnectedKit();\n        // kit is connected to a wallet\n        try {\n          setConfirmLoading(true);\n          const bank = (new kit.web3.eth.Contract(\n            BANK_ABI.abi as AbiItem[],\n            getAddress(Bank[network.chainId])\n            ) as unknown) as HomoraBank;\n          const spell = (new kit.web3.eth.Contract(\n            UNI_SPELL.abi as AbiItem[],\n            getAddress(props.pool.spell),\n          ) as unknown) as UniswapV2SpellV1;\n          const bytes = spell.methods.removeLiquidityWERC20(\n            props.pool.tokens[0]!.address, \n            props.pool.tokens[1]!.address, \n            [\n              MaxUint256.toString(),\n              0, \n              MaxUint256.toString(), \n              MaxUint256.toString(), \n              0, \n              0, \n              0\n            ],\n          ).encodeABI()\n          const tx = await bank.methods\n            .execute(\n                0,\n                props.pool.spell,\n                bytes,\n            ).send({\n              from: kit.defaultAccount,\n              gasPrice: DEFAULT_GAS_PRICE,\n              gas: 10000000,\n            });\n          toastTx(tx.transactionHash);\n        } catch (e) {\n          toast(e.message);\n        } finally {\n          setConfirmLoading(false);\n        }\n      }}\n    >\n      Close\n    </Button>\n  );\n\n  const harvestButton = (<Button\n  onClick={async () => {\n    const kit = await getConnectedKit();\n    // kit is connected to a wallet\n    try {\n      setConfirmLoading(true);\n      const bank = (new kit.web3.eth.Contract(\n        BANK_ABI.abi as AbiItem[],\n        getAddress(Bank[network.chainId])\n        ) as unknown) as HomoraBank;\n      const spell = (new kit.web3.eth.Contract(\n        UNI_SPELL.abi as AbiItem[],\n        getAddress(props.pool.spell),\n      ) as unknown) as UniswapV2SpellV1;\n      const bytes = spell.methods.removeLiquidityWERC20(\n        props.pool.tokens[0]!.address, \n        props.pool.tokens[1]!.address, \n        [\n          MaxUint256.toString(),\n          0, \n          MaxUint256.toString(), \n          MaxUint256.toString(), \n          0, \n          0, \n          0\n        ],\n      ).encodeABI()\n      const tx = await bank.methods\n        .execute(\n            0,\n            props.pool.spell,\n            bytes,\n        ).send({\n          from: kit.defaultAccount,\n          gasPrice: DEFAULT_GAS_PRICE,\n          gas: 10000000,\n        });\n      toastTx(tx.transactionHash);\n    } catch (e) {\n      toast(e.message);\n    } finally {\n      setConfirmLoading(false);\n    }\n  }}\n>\n  Harvest\n</Button>\n);\n\n  const urlext = props.positionId + \"/\" + props.collateralSize + \"/\" + props.pool.name + \"/\" + props.pool.wrapper + \"/\" + props.pool.spell + \"/\" + props.pool.lp + \"/\"\n    + props.pool.tokens.map((tok) => tok.address)\n\n  return (\n    <Row>\n      <td>\n      <FarmInfo props={props.pool} />\n      </td>\n      <td>A lot</td>\n      <td>A lot</td>\n      <td>High</td>\n      <td>High</td>\n      <td\n        css={css`\n          text-align: right;\n        `}\n      >\n        <Flex sx={{justifyContent: \"center\", alignItems: \"center\", flexDirection: \"column\", gap: \"6px\"}}>\n          <Flex sx={{justifyContent: \"center\", alighnItems: \"center\", gap: \"6px\"}}>\n            <Button onClick={() => {\n             history.push(`positions/add/${urlext}`)}\n            }>\n              Add\n            </Button>\n            <Button onClick={() => {\n             history.push(`positions/remove/${urlext}`)}\n            }>\n              Remove\n            </Button>\n          </Flex>\n          <Flex sx={{justifyContent: \"center\", alighnItems: \"center\", gap: \"6px\"}}>\n            {closeButton}\n            {harvestButton}\n          </Flex>\n        </Flex>\n        \n      </td>\n    </Row>\n  );\n};\n\nconst Row = styled.tr`\n  height: 72px;\n`;"]},"metadata":{},"sourceType":"module"}